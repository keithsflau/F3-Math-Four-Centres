<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>中三數學：三角形的四心互動學習</title>
  <style>
    :root {
      color-scheme: light;
      font-family: "Noto Sans TC", "Microsoft JhengHei", sans-serif;
    }
    body {
      margin: 0;
      background: #f5f7fb;
      color: #1f2a44;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      background: linear-gradient(135deg, #4f8ef5, #6bc4f7);
      color: #fff;
      padding: 24px 32px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
    }
    header h1 {
      margin: 0;
      font-size: 1.9rem;
      letter-spacing: 1px;
    }
    main {
      flex: 1;
      padding: 24px 32px 48px;
      display: grid;
      gap: 24px;
      grid-template-columns: minmax(320px, 700px) minmax(240px, 1fr);
    }
    section {
      background: #ffffff;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 2px 12px rgba(15, 50, 95, 0.12);
    }
    #canvasWrapper {
      position: relative;
    }
    canvas {
      width: 100%;
      height: auto;
      border-radius: 12px;
      background: #ffffff;
      box-shadow: inset 0 0 0 1px rgba(79, 142, 245, 0.15);
      cursor: grab;
    }
    canvas:active {
      cursor: grabbing;
    }
    .panel-title {
      font-weight: 700;
      margin-bottom: 12px;
      font-size: 1.05rem;
    }
    .toggle-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 18px;
    }
    .toggle-group label {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      border-radius: 8px;
      background: rgba(79, 142, 245, 0.08);
      transition: background 0.2s ease;
    }
    .toggle-group label:hover {
      background: rgba(79, 142, 245, 0.18);
    }
    input[type="checkbox"] {
      accent-color: #4f8ef5;
      width: 18px;
      height: 18px;
    }
    .info-box {
      background: #f0f6ff;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 16px;
      line-height: 1.6;
    }
    .info-box strong {
      color: #1f5dc0;
    }
    .tooltip {
      position: absolute;
      pointer-events: none;
      background: rgba(0, 25, 66, 0.92);
      color: #fff;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 0.85rem;
      line-height: 1.5;
      max-width: 220px;
      filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.25));
      transform: translate(-50%, calc(-100% - 16px));
      z-index: 10;
      white-space: pre-line;
    }
    .tooltip::after {
      content: "";
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: -8px;
      border-width: 8px 8px 0 8px;
      border-style: solid;
      border-color: rgba(0, 25, 66, 0.92) transparent transparent transparent;
    }
    .task-panel h3 {
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 1rem;
      color: #1f5dc0;
    }
    .task-panel p {
      margin: 0 0 8px;
      line-height: 1.6;
    }
    .task-panel ul {
      padding-left: 18px;
      margin: 0;
      line-height: 1.6;
    }
    .quiz-card {
      background: #fff6f0;
      border-radius: 12px;
      padding: 18px;
      border: 1px solid rgba(255, 153, 76, 0.35);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .quiz-card h4 {
      margin: 0;
      color: #e0671f;
    }
    .quiz-options label {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }
    .quiz-options input[type="radio"] {
      accent-color: #e0671f;
    }
    .feedback {
      font-weight: 600;
      min-height: 1.2em;
    }
    .feedback.correct {
      color: #16873d;
    }
    .feedback.incorrect {
      color: #c62828;
    }
    footer {
      padding: 16px 32px 24px;
      font-size: 0.85rem;
      color: #4f5b77;
      text-align: center;
    }
    @media (max-width: 960px) {
      main {
        grid-template-columns: 1fr;
      }
      canvas {
        min-height: 340px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>中三數學：三角形的四心互動學習</h1>
  </header>

  <main>
    <section id="canvasWrapper">
      <div class="panel-title">拖動頂點，觀察四心變化</div>
      <canvas id="geoCanvas" width="620" height="480"></canvas>
      <div id="tooltip" class="tooltip" style="display:none;"></div>
    </section>

    <section>
      <div class="panel-title">學習提示與任務</div>

      <div class="info-box">
        <strong>互動提示：</strong>
        嘗試將三角形變成等腰或鈍角，留意四心位置如何改變。你可以利用右方按鈕隱藏／顯示不同中心，集中觀察。
      </div>

      <div class="toggle-group">
        <!-- 教師可按需要修改標籤文字 -->
        <label><input type="checkbox" id="toggleCircumcenter" checked /> 外心（O）</label>
        <label><input type="checkbox" id="toggleIncenter" checked /> 內心（I）</label>
        <label><input type="checkbox" id="toggleCentroid" checked /> 形心（G）</label>
        <label><input type="checkbox" id="toggleOrthocenter" checked /> 垂心（H）</label>
      </div>

      <div class="task-panel">
        <h3>建議互動任務</h3>
        <p>1. 調整三角形，找出何時外心位於三角形外面，並解釋原因。</p>
        <p>2. 內心與三角形哪部分息息相關？觀察並描述。</p>
        <p>3. 用自己的話說明形心與三角形三條中線的關係。</p>
        <p>4. 嘗試將三角形調整為直角三角形，觀察垂心與外心的相對位置。</p>
      </div>

      <div class="task-panel" style="margin-top:18px;">
        <h3>挑戰題（教師可自訂）</h3>
        <ul>
          <li>思考：如果是等邊三角形，四心有甚麼特別？</li>
          <li>探究：把其中一個頂點拖得很遠，四心之間的距離變化如何？</li>
        </ul>
      </div>

      <div class="quiz-card" style="margin-top:18px;">
        <h4>即時小測：哪些中心一定在三角形內部？（可多選）</h4>
        <div class="quiz-options">
          <label><input type="checkbox" name="quiz" value="circum"> 外心</label>
          <label><input type="checkbox" name="quiz" value="in"> 內心</label>
          <label><input type="checkbox" name="quiz" value="centroid"> 形心</label>
          <label><input type="checkbox" name="quiz" value="ortho"> 垂心</label>
        </div>
        <button id="checkAnswer" style="align-self:flex-start;padding:8px 14px;border-radius:8px;border:none;background:#e0671f;color:#fff;font-weight:600;cursor:pointer;">檢查答案</button>
        <div id="quizFeedback" class="feedback"></div>
      </div>
    </section>
  </main>

  <footer>
    提示：教師可根據課堂需要，於程式註解部分調整文字、問題或加入更多延伸活動。
  </footer>

  <script>
    // -----------------------------
    // 幾何計算與互動邏輯
    // -----------------------------
    const canvas = document.getElementById("geoCanvas");
    const ctx = canvas.getContext("2d");
    const tooltip = document.getElementById("tooltip");

    // 初始三角形頂點位置
    const points = [
      { x: 160, y: 360, label: "A", color: "#ff6b6b" },
      { x: 440, y: 360, label: "B", color: "#ffa94d" },
      { x: 320, y: 140, label: "C", color: "#4dabf7" }
    ];

    // 四心的顯示控制
    const centerToggles = {
      circumcenter: document.getElementById("toggleCircumcenter"),
      incenter: document.getElementById("toggleIncenter"),
      centroid: document.getElementById("toggleCentroid"),
      orthocenter: document.getElementById("toggleOrthocenter")
    };

    // 四心定義
    const centerDefinitions = {
      circumcenter: "外心 O：三角形三邊垂直平分線的交點，\n至三個頂點的距離相等。",
      incenter: "內心 I：三角形三個內角角平分線的交點，\n至三邊的距離相等，是內切圓圓心。",
      centroid: "形心 G：三角形三條中線的交點，\n每條中線被形心分成 2:1。",
      orthocenter: "垂心 H：三角形三條高線的交點，\n位置會隨三角形形狀改變。"
    };

    // 互動拖曳控制
    let dragTarget = null;
    let isDragging = false;

    function distance(p1, p2) {
      return Math.hypot(p1.x - p2.x, p1.y - p2.y);
    }

    function computeTriangleData() {
      const [A, B, C] = points;

      const sideLengths = {
        AB: distance(A, B),
        BC: distance(B, C),
        CA: distance(C, A)
      };
      const perimeter = sideLengths.AB + sideLengths.BC + sideLengths.CA;
      const semiPerimeter = perimeter / 2;
      const doubleArea =
        A.x * (B.y - C.y) + B.x * (C.y - A.y) + C.x * (A.y - B.y);
      const area = Math.abs(doubleArea) / 2;
      const inradius =
        perimeter > 0 && semiPerimeter > 0 ? area / semiPerimeter : 0;

      // 形心
      const centroid = {
        x: (A.x + B.x + C.x) / 3,
        y: (A.y + B.y + C.y) / 3,
        label: "G",
        color: "#2d6cdf"
      };

      // 內心
      const a = sideLengths.BC;
      const b = sideLengths.CA;
      const c = sideLengths.AB;
      const safePerimeter = perimeter === 0 ? 1 : perimeter;
      const incenter = {
        x: (a * A.x + b * B.x + c * C.x) / safePerimeter,
        y: (a * A.y + b * B.y + c * C.y) / safePerimeter,
        label: "I",
        color: "#12b886",
        radius: inradius
      };

      // 外心（利用向量公式）
      const d = 2 * (A.x * (B.y - C.y) + B.x * (C.y - A.y) + C.x * (A.y - B.y));
      let circumcenter = null;
      if (Math.abs(d) > 1e-6) {
        const ux =
          ((A.x * A.x + A.y * A.y) * (B.y - C.y) +
            (B.x * B.x + B.y * B.y) * (C.y - A.y) +
            (C.x * C.x + C.y * C.y) * (A.y - B.y)) / d;
        const uy =
          ((A.x * A.x + A.y * A.y) * (C.x - B.x) +
            (B.x * B.x + B.y * B.y) * (A.x - C.x) +
            (C.x * C.x + C.y * C.y) * (B.x - A.x)) / d;
        circumcenter = {
          x: ux,
          y: uy,
          label: "O",
          color: "#845ef7",
          radius: distance({ x: ux, y: uy }, A)
        };
      }

      // 垂心（向量法：H = A + B + C - 2*O, 需利用外接圓心）
      let orthocenter = null;
      if (circumcenter) {
        orthocenter = {
          x: A.x + B.x + C.x - 2 * circumcenter.x,
          y: A.y + B.y + C.y - 2 * circumcenter.y,
          label: "H",
          color: "#f03e3e"
        };
      }

      return {
        centers: { centroid, incenter, circumcenter, orthocenter },
        sideLengths
      };
    }

    function drawTriangle() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // 補助網格
      drawGrid();

      // 三角形邊
      ctx.beginPath();
      ctx.moveTo(points[0].x, points[0].y);
      ctx.lineTo(points[1].x, points[1].y);
      ctx.lineTo(points[2].x, points[2].y);
      ctx.closePath();
      ctx.fillStyle = "rgba(79, 142, 245, 0.08)";
      ctx.fill();
      ctx.lineWidth = 2;
      ctx.strokeStyle = "rgba(45, 108, 223, 0.5)";
      ctx.stroke();

      // 頂點
      points.forEach((pt) => drawPoint(pt));

      // 四心
      const triangleData = computeTriangleData();
      const centers = triangleData.centers;
      const hoverInfo = detectHover(centers);

      drawSideLengths(triangleData.sideLengths);
      if (centerToggles.circumcenter.checked && centers.circumcenter?.radius) {
        drawCircumcircle(centers.circumcenter);
      }
      if (centerToggles.incenter.checked && centers.incenter?.radius) {
        drawIncircle(centers.incenter);
      }
      drawCenters(centers, hoverInfo);

      if (hoverInfo) {
        showTooltip(hoverInfo);
      } else {
        tooltip.style.display = "none";
      }
    }

    function drawGrid() {
      const step = 40;
      ctx.save();
      ctx.strokeStyle = "rgba(173, 197, 255, 0.25)";
      ctx.lineWidth = 1;
      for (let x = step; x < canvas.width; x += step) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvas.height);
        ctx.stroke();
      }
      for (let y = step; y < canvas.height; y += step) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(canvas.width, y);
        ctx.stroke();
      }
      ctx.restore();
    }

    function drawPoint(pt) {
      ctx.beginPath();
      ctx.arc(pt.x, pt.y, 10, 0, Math.PI * 2);
      ctx.fillStyle = pt.color;
      ctx.fill();
      ctx.lineWidth = 2;
      ctx.strokeStyle = "#ffffff";
      ctx.stroke();

      ctx.font = "16px 'Noto Sans TC', sans-serif";
      ctx.fillStyle = "#1f2a44";
      ctx.fillText(pt.label, pt.x + 12, pt.y - 12);
    }

    function drawSideLengths(lengths) {
      if (
        !Number.isFinite(lengths.AB) ||
        !Number.isFinite(lengths.BC) ||
        !Number.isFinite(lengths.CA)
      ) {
        return;
      }

      ctx.font = "14px 'Noto Sans TC', sans-serif";
      ctx.textBaseline = "middle";

      const labels = [
        {
          text: `AB = ${lengths.AB.toFixed(1)}`,
          position: { x: (points[0].x + points[1].x) / 2, y: (points[0].y + points[1].y) / 2 }
        },
        {
          text: `BC = ${lengths.BC.toFixed(1)}`,
          position: { x: (points[1].x + points[2].x) / 2, y: (points[1].y + points[2].y) / 2 }
        },
        {
          text: `CA = ${lengths.CA.toFixed(1)}`,
          position: { x: (points[2].x + points[0].x) / 2, y: (points[2].y + points[0].y) / 2 }
        }
      ];

      labels.forEach(({ text, position }) => drawLabel(text, position.x, position.y));
      ctx.textBaseline = "alphabetic";
    }

    function drawLabel(text, x, y) {
      ctx.save();
      ctx.font = "14px 'Noto Sans TC', sans-serif";
      const padding = 6;
      const metrics = ctx.measureText(text);
      const labelWidth = metrics.width;
      const labelHeight = 20;
      ctx.fillStyle = "rgba(255, 255, 255, 0.85)";
      ctx.fillRect(
        x - labelWidth / 2 - padding,
        y - labelHeight / 2,
        labelWidth + padding * 2,
        labelHeight
      );
      ctx.strokeStyle = "rgba(39, 64, 96, 0.25)";
      ctx.strokeRect(
        x - labelWidth / 2 - padding,
        y - labelHeight / 2,
        labelWidth + padding * 2,
        labelHeight
      );
      ctx.fillStyle = "#274060";
      ctx.fillText(text, x - labelWidth / 2, y + 1);
      ctx.restore();
    }

    function drawIncircle(incenter) {
      ctx.save();
      ctx.beginPath();
      ctx.arc(incenter.x, incenter.y, incenter.radius, 0, Math.PI * 2);
      ctx.strokeStyle = "rgba(18, 184, 134, 0.6)";
      ctx.lineWidth = 2;
      ctx.setLineDash([6, 6]);
      ctx.stroke();
      ctx.restore();
    }

    function drawCircumcircle(circumcenter) {
      ctx.save();
      ctx.beginPath();
      ctx.arc(circumcenter.x, circumcenter.y, circumcenter.radius, 0, Math.PI * 2);
      ctx.strokeStyle = "rgba(132, 94, 247, 0.6)";
      ctx.lineWidth = 2;
      ctx.setLineDash([10, 6]);
      ctx.stroke();
      ctx.restore();
    }

    function drawCenters(centers, hoverInfo) {
      const radius = 8;

      Object.entries(centers).forEach(([key, center]) => {
        if (!center) return;
        if (!centerToggles[key].checked) return;

        ctx.beginPath();
        ctx.arc(center.x, center.y, radius, 0, Math.PI * 2);
        ctx.fillStyle = center.color;
        ctx.fill();

        ctx.lineWidth = hoverInfo && hoverInfo.key === key ? 3 : 2;
        ctx.strokeStyle = "#ffffff";
        ctx.stroke();

        ctx.font = "14px 'Noto Sans TC', sans-serif";
        ctx.fillStyle = "#1f2a44";
        ctx.fillText(center.label, center.x + 10, center.y - 10);
      });
    }

    function detectHover(centers) {
      const mouse = currentMousePos;
      if (!mouse) return null;

      const radius = 12;
      for (const [key, center] of Object.entries(centers)) {
        if (!center || !centerToggles[key].checked) continue;
        if (distance(center, mouse) < radius) {
          return { key, center };
        }
      }
      return null;
    }

    function showTooltip({ key, center }) {
      tooltip.style.display = "block";
      tooltip.textContent = centerDefinitions[key];
      tooltip.style.left = `${center.x}px`;
      tooltip.style.top = `${center.y}px`;
    }

    let currentMousePos = null;

    canvas.addEventListener("mousedown", (event) => {
      const { x, y } = getMousePos(event);
      dragTarget = points.find((pt) => distance(pt, { x, y }) < 15);
      isDragging = Boolean(dragTarget);
    });

    canvas.addEventListener("mousemove", (event) => {
      const { x, y } = getMousePos(event);
      currentMousePos = { x, y };

      if (isDragging && dragTarget) {
        dragTarget.x = x;
        dragTarget.y = y;
      }
    });

    canvas.addEventListener("mouseup", () => {
      isDragging = false;
      dragTarget = null;
    });

    canvas.addEventListener("mouseleave", () => {
      isDragging = false;
      dragTarget = null;
      currentMousePos = null;
      tooltip.style.display = "none";
    });

    function getMousePos(event) {
      const rect = canvas.getBoundingClientRect();
      return {
        x: ((event.clientX - rect.left) / rect.width) * canvas.width,
        y: ((event.clientY - rect.top) / rect.height) * canvas.height
      };
    }

    Object.values(centerToggles).forEach((checkbox) =>
      checkbox.addEventListener("change", () => drawTriangle())
    );

    function animate() {
      drawTriangle();
      requestAnimationFrame(animate);
    }
    animate();

    // -----------------------------
    // 小測互動邏輯
    // -----------------------------
    const checkButton = document.getElementById("checkAnswer");
    const feedback = document.getElementById("quizFeedback");

    checkButton.addEventListener("click", () => {
      const selected = Array.from(document.querySelectorAll('input[name="quiz"]:checked')).map(
        (input) => input.value
      );
      if (selected.length === 0) {
        feedback.textContent = "請至少勾選一項答案。";
        feedback.className = "feedback incorrect";
        return;
      }

      const correctSet = ["in", "centroid"];
      const allCorrect = correctSet.every((ans) => selected.includes(ans));
      const extraChoices = selected.filter((ans) => !correctSet.includes(ans));

      if (allCorrect && extraChoices.length === 0 && selected.length === correctSet.length) {
        feedback.textContent = "答對了！內心與形心都一定在三角形內部。";
        feedback.className = "feedback correct";
      } else if (allCorrect && extraChoices.length === 0) {
        feedback.textContent = "不錯！還有一個正確答案，試試全部勾選。";
        feedback.className = "feedback incorrect";
      } else if (extraChoices.length > 0) {
        feedback.textContent = "再試一次！留意哪些中心有時會在三角形外。";
        feedback.className = "feedback incorrect";
      } else {
        feedback.textContent = "接近了！再想想還有哪個中心必定位於三角形內。";
        feedback.className = "feedback incorrect";
      }
    });
  </script>
</body>
</html>
